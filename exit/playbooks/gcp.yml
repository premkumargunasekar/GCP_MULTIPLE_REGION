---
- name: GCP Multi-Region Subnet Allocator (Max 5 per run)
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    github_repo_url: "https://github.com/premkumargunasekar/GCP_MULTIPLE_REGION.git"
    repo_local_path: "/tmp/ip-repo"
    excel_file_path: "{{ repo_local_path }}/cidr_data/cidr_pool.csv"
    vpc_name: "prem-vpc-network"
    project_id: "curious-idea-475408-d2"

    subnet_requests: "{{ subnet_requests | default([]) }}"
    remarks: "{{ remarks | default('Created via AAP/ServiceNow Catalog') }}"
    allowed_sizes: ['/23','/24','/25','/26','/27','/28','/29']
    max_requests: 5

  tasks:

    - name: Validate number of subnet requests
      ansible.builtin.assert:
        that:
          - subnet_requests | length > 0
          - subnet_requests | length <= max_requests
        fail_msg: "Request must include 1â€“{{ max_requests }} subnets."

    - name: Validate subnet size values
      vars:
        invalids: "{{ subnet_requests | map(attribute='subnet_size') | reject('in', allowed_sizes) | list }}"
      ansible.builtin.assert:
        that:
          - invalids | length == 0
        fail_msg: "Invalid subnet sizes: {{ invalids }}. Allowed: {{ allowed_sizes }}"

    - name: Ensure git is available
      ansible.builtin.command: git --version
      register: git_check
      failed_when: git_check.rc != 0
      changed_when: false

    - name: Clone latest CIDR repo from GitHub
      ansible.builtin.git:
        repo: "{{ github_repo_url }}"
        dest: "{{ repo_local_path }}"
        version: main
        force: yes
      delegate_to: localhost
      become: false

    - name: Read pool data from CSV
      community.general.read_csv:
        path: "{{ excel_file_path }}"
      register: pool_data

    - name: Filter available CIDR pools (Free or Partially)
      ansible.builtin.set_fact:
        candidate_pools: "{{ pool_data.list | selectattr('Status', 'match', '(?i)Free|Partially') | list }}"

    - name: Fail if no candidate pools
      ansible.builtin.fail:
        msg: "No Free or Partially Used CIDRs found in {{ excel_file_path }}"
      when: candidate_pools | length == 0

    - name: Initialize allocation results
      ansible.builtin.set_fact:
        allocation_results: []

    - name: Allocate subnets for each request
      ansible.builtin.include_tasks: allocate_subnet.yml
      loop: "{{ subnet_requests }}"
      loop_control:
        loop_var: req
        index_var: req_idx
      vars:
        candidate_pools: "{{ candidate_pools }}"
        project_id: "{{ project_id }}"
        vpc_name: "{{ vpc_name }}"
        repo_local_path: "{{ repo_local_path }}"
        excel_file_path: "{{ excel_file_path }}"
        remarks: "{{ remarks }}"
        allocation_results: "{{ allocation_results }}"
        subnet_requests: "{{ subnet_requests }}"
        github_repo_url: "{{ github_repo_url }}"

    - name: Show allocation summary
      ansible.builtin.debug:
        var: allocation_results

    - name: Commit and push updates to GitHub
      ansible.builtin.shell: |
        cd {{ repo_local_path }}
        git config user.name "ansible-automation"
        git config user.email "ansible@domain.com"
        git add .
        git commit -m "Subnet allocations via AAP: {{ remarks }}"
        git push origin main
      register: git_push
      changed_when: "'nothing to commit' not in git_push.stdout"

    - name: Final summary
      ansible.builtin.debug:
        msg:
          - "âœ… Subnet allocations completed successfully"
          - "{{ allocation_results }}"
