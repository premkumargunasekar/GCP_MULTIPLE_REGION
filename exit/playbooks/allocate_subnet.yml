---
# allocate_subnet.yml
# Expects vars from parent:
#   - req (loop var): { name, region, subnet_size }
#   - candidate_pools (list of csv rows/dicts)
#   - excel_file_path, repo_local_path, audit_file, remarks

- name: Select candidate pool for request (by region if column exists)
  ansible.builtin.set_fact:
    selected_pool: >-
      {{
        (candidate_pools | selectattr('Region','defined') | selectattr('Region','equalto', req.region) | list | first)
        or
        (candidate_pools | first)
      }}

- name: Fail if selected_pool missing or no CIDR column
  ansible.builtin.assert:
    that:
      - selected_pool is defined
      - selected_pool.CIDR is defined
    fail_msg: "No suitable CIDR pool found for request {{ req }} or CIDR column missing in CSV."

- name: Gather already allocated list from pool (if Allocated_Subnets column exists)
  ansible.builtin.set_fact:
    existing_allocated: "{{ (selected_pool.Allocated_Subnets | default('')) | trim() | ternary(selected_pool.Allocated_Subnets.split(';'), []) }}"

- name: Compute next available subnet using python ipaddress
  ansible.builtin.shell: |
    python3 - <<'PY'
    import sys, json, ipaddress
    data = json.loads(sys.stdin.read())
    pool = data['pool']
    prefix = int(data['prefix'].lstrip('/'))
    existing = data.get('existing', [])
    net = ipaddress.ip_network(pool)
    for sub in net.subnets(new_prefix=prefix):
        if str(sub) not in existing:
            print(str(sub))
            sys.exit(0)
    # no available subnet
    sys.exit(1)
    PY
  args:
    stdin: >-
      {{
        {
          'pool': selected_pool.CIDR,
          'prefix': req.subnet_size,
          'existing': existing_allocated
        } | to_json
      }}
  register: alloc_result
  failed_when: alloc_result.rc != 0
  changed_when: true

- name: Set allocated_cidr fact
  ansible.builtin.set_fact:
    allocated_cidr: "{{ alloc_result.stdout_lines[0] | default(alloc_result.stdout) }}"

- name: Append audit log entry
  ansible.builtin.lineinfile:
    path: "{{ audit_file }}"
    create: yes
    line: "{{ '%Y-%m-%d %H:%M:%S' | strftime }} | RequestIndex:{{ req_idx }} | Name:{{ req.name }} | Region:{{ req.region }} | Size:{{ req.subnet_size }} | PoolCIDR:{{ selected_pool.CIDR }} | Allocated:{{ allocated_cidr }} | Remarks: {{ remarks }}"
  delegate_to: localhost

- name: Record allocation into results list
  ansible.builtin.set_fact:
    allocation_results: >-
      {{
        allocation_results + [
          {
            'request_index': req_idx,
            'name': req.name,
            'region': req.region,
            'requested_size': req.subnet_size,
            'allocated_cidr': allocated_cidr,
            'pool_cidr': selected_pool.CIDR
          }
        ]
      }}

# Optional: update CSV 'Allocated_Subnets' & 'Status' columns in repo
# This is a minimal safe approach: append an "allocation record" file rather than rewriting CSV.
# If you want full CSV writeback, implement rewriting logic carefully (or use a dedicated module).
- name: Append short allocation record CSV (safe, incremental)
  ansible.builtin.lineinfile:
    path: "{{ repo_local_path }}/cidr_data/allocations_append.csv"
    create: yes
    line: "{{ allocated_cidr }},{{ req.name }},{{ req.region }},{{ req.subnet_size }},{{ selected_pool.CIDR }},{{ remarks }},{{ '%Y-%m-%dT%H:%M:%S' | strftime }}"
  delegate_to: localhost

# Note: the main play commits the repo; the append file is a safe incremental log that does not rewrite the pool CSV.
