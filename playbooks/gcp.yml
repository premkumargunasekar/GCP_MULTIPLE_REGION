---
- name: GCP Multi-Region Subnet Allocator (Max 5 per run)
  hosts: localhost
  become: true
  become_method: sudo
  gather_facts: no

  vars:
    github_repo_url: "https://github.com/username/GCP_MULTIPLE_REGION.git"
    repo_local_path: "/tmp/ip-repo"
    excel_file_path: "{{ repo_local_path }}/cidr_data/cidr_pool.csv"
    pool_sheet: "cidr_pool_master"
    vpc_name: "prem-vpc-network"
    project_id: "curious-idea-475408-d2"

    subnet_requests: "{{ subnet_requests | default([]) }}"
    remarks: "{{ remarks | default('Created via AAP/ServiceNow Catalog') }}"
    allowed_sizes: ['/23','/24','/25','/26','/27','/28','/29']
    max_requests: 5

  tasks:

    - name: Validate number of subnet requests
      ansible.builtin.assert:
        that:
          - subnet_requests | length > 0
          - subnet_requests | length <= max_requests
        fail_msg: "Request must include 1–{{ max_requests }} subnets."

    - name: Validate subnet size values
      vars:
        invalids: "{{ subnet_requests | map(attribute='subnet_size') | reject('in', allowed_sizes) | list }}"
      ansible.builtin.assert:
        that:
          - invalids | length == 0
        fail_msg: "Invalid subnet sizes: {{ invalids }}. Allowed: {{ allowed_sizes }}"

    - name: Skip git installation in AWX
      ansible.builtin.debug:
         msg: "Git installation skipped — already available in the container."


    - name: Clone latest CIDR repo from GitHub
      ansible.builtin.git:
        repo: "{{ github_repo_url }}"
        dest: "{{ repo_local_path }}"
        version: main
        force: yes

    - name: Read pool data from CSV
      ansible.builtin.read_csv:
        path: "{{ excel_file_path }}"
      register: pool_data

    - name: Extract available CIDR pools (Free or Partially)
      ansible.builtin.set_fact:
        candidate_pools: "{{ pool_data.list | selectattr('Status','match','(?i)Free|Partially') | list }}"

    - name: Fail if no candidate pools
      ansible.builtin.fail:
        msg: "No Free or Partially Used CIDRs found in {{ excel_file_path }}"
      when: candidate_pools | length == 0

    - name: Initialize allocation results list
      ansible.builtin.set_fact:
        allocation_results: []

    - name: Include subnet allocation for each request
      ansible.builtin.include_tasks: allocate_subnet.yml
      loop: "{{ subnet_requests }}"
      loop_control:
        loop_var: req
        index_var: req_idx
      vars:
        candidate_pools: "{{ candidate_pools }}"
        project_id: "{{ project_id }}"
        vpc_name: "{{ vpc_name }}"
        repo_local_path: "{{ repo_local_path }}"
        excel_file_path: "{{ excel_file_path }}"
        pool_sheet: "{{ pool_sheet }}"
        remarks: "{{ remarks }}"
        allocation_results: "{{ allocation_results }}"
        subnet_requests: "{{ subnet_requests }}"
        github_repo_url: "{{ github_repo_url }}"

    - name: Display allocation summary
      ansible.builtin.debug:
        var: allocation_results

    - name: Commit and push CSV updates to GitHub
      ansible.builtin.shell: |
        cd {{ repo_local_path }}
        git config user.name "ansible-automation"
        git config user.email "ansible@domain.com"
        git add "{{ excel_file_path }}"
        git commit -m "Subnet allocations via AAP: {{ remarks }}"
        git push origin main
      register: git_push
      changed_when: "'nothing to commit' not in git_push.stdout"

    - name: Final summary
      ansible.builtin.debug:
        msg:
          - "✅ Subnet allocations completed successfully"
          - "{{ allocation_results }}"
